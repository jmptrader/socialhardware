<dom-module id="load-network">
  <style>
    :host {
      display: block;
    }

    .dark-container {
      background-color: var(--load-network-dark-container-background-color);
      color: var(--load-network-dark-container-color);
      font: var(--load-network-dark-container-font);
    }
  </style>

  <template>

    <style>
    .title {
        display: inline-flex;
        padding-left: 1.4em;
        padding-top: 1em;
        padding-bottom: 1em;
        font: var(--paper-font-subhead);
      }
      /* FIXME: this should come from the host css somehow?!? */

      .vertical-section {
        background-color: white;
        padding: 24px;
        margin: 0 24px 24px 24px;
        @apply(--shadow-elevation-2dp);
      }

      .horizontal-section {
        background-color: white;
        padding: 24px;
        margin-right: 24px;
        min-width: 200px;
        @apply(--shadow-elevation-2dp);
      }

      .centered {
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }
    }
    </style>

    <!--  <paper-material elevation="1"> -->

    <h2 class="title">
      Network -
      <span>{{netid}}</span>
    </h2>
    <paper-button id="create-stream-btn" raised>Add Stream</paper-button>
    <!--  </paper-material> -->

    <!--<paper-material elevation="1">-->
    <div class="dark-container">
      <paper-icon-button icon="menu" on-click="handleTriggerToggle"></paper-icon-button>
      Add Trigger
      <iron-collapse id="add-trigger-1">
        <div class="vertical-section centered dark-container">
          <create-trigger netid="{{netid}}"></create-trigger>

        </div>
      </iron-collapse>
    </div>

    <!--</paper-material>-->

    <template is="dom-repeat" items="{{streams}}">

      <paper-material elevation="1">
        <paper-icon-button icon="menu" on-click="handleToggle"></paper-icon-button>
        <div class="title">streamID:
          <span>{{item.streamId}}</span>
        </div>
        <iron-collapse id="{{computeCollapseId(index)}}" opened>

          <line-chart width="100%" height="100%" netid="{{item.networkId}}" streamid="{{item.streamId}}"></line-chart>

        </iron-collapse>
      </paper-material>

    </template>


  </template>
</dom-module>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js" charset="utf-8"></script>
<script>
  (function() {

    Polymer({
      is: 'load-network',

      properties: {
        netid: String //the id for this network
      },

      listeners: {
        'create-stream-btn.click': 'handleClick'
      },



      attached: function() {
        this.loadStreamList();
      },

      computeCollapseId: function(index) {
        return "collapse" + index;
      },

      handleToggle: function(e) {
        var collapseElm = document.querySelector('#collapse' + e.model.index);
        collapseElm.toggle();
      },

      handleTriggerToggle: function(e) {
        var collapseTrigger = this.$['add-trigger-1']//document.querySelector('#add-trigger-1');
        collapseTrigger.toggle();
      },

      handleClick: function() {
        var poly = this;

        //TODO: replace with polymer ajax method
        d3.json('/api/v1/networks/' + this.netid + '/streams')
          .header("Content-Type", "application/json")
          .header("Authorization", "Bearer " + poly.getJWToken())
          .post(JSON.stringify({}), function(error, data) {
            //request server error
            if (error) {
              console.log(error);
              return;
            }
            poly.loadStreamList(); //TODO: or just return the new stream id?
          });

      },

      loadStreamList: function() {
        var poly = this;

        //load list of streams
        //TODO: replace with polymer ajax method
        d3.json('/api/v1/networks/' + this.netid + '/streams')
          .header("Authorization", "Bearer " + poly.getJWToken())
          .get(function(error, data) {

            //request server error
            if (error) {
              console.log(error);
              return;
            }
            console.log(JSON.stringify(data));

            //no streams data. Do nothing.
            if (!data.length) {
              return;
            }
            poly.streams = data;
          });
      },

      getJWToken: function() {
        if (sessionStorage.getItem("token")) {
          return sessionStorage.getItem("token");
        }
      }


    });

  })();
</script>
